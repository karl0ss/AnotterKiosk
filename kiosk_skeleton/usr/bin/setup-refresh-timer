#!/bin/bash

INI_FILE="/boot/kioskbrowser.ini"
REFRESH_INTERVAL=$(awk -F '=' '/^\[screen\]/ { in_screen=1; next }
                                in_screen && /^\[/ { in_screen=0 }
                                in_screen && $1 ~ /refresh_screen_every_x_min/ { gsub(/ /, "", $2); print $2 }' "$INI_FILE")

# Safely check if REFRESH_INTERVAL is a positive integer
if [[ "$REFRESH_INTERVAL" =~ ^[0-9]+$ ]] && (( REFRESH_INTERVAL > 0 )); then
    echo "Setting up screen refresh every $REFRESH_INTERVAL minutes..."

    SERVICE_UNIT="/etc/systemd/system/screen-refresh.service"
    TIMER_UNIT="/etc/systemd/system/screen-refresh.timer"

    cat <<EOF | sudo tee "$SERVICE_UNIT" > /dev/null
[Unit]
Description=Refresh Screen

[Service]
Type=oneshot
ExecStart=/usr/bin/refresh-screen
EOF

    cat <<EOF | sudo tee "$TIMER_UNIT" > /dev/null
[Unit]
Description=Run screen refresh every $REFRESH_INTERVAL minutes

[Timer]
OnBootSec=1min
OnUnitActiveSec=${REFRESH_INTERVAL}min
Persistent=false

[Install]
WantedBy=timers.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable --now screen-refresh.timer
else
    echo "Invalid or missing refresh interval"
fi